generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Cliente {
  id              String               @id
  nombre          String
  rut             String?
  email           String?
  telefono        String?
  estado          ClientStatus         @default(Activo)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime
  ciudad          String?
  comuna          String?
  direccion       String?
  personaContacto String?
  region          String?
  lineaCredito    Int                  @default(0)
  metodoPagoUnico EcommerceMetodoPago? @ignore
  vendedorId      String?

  @@index([nombre])
  @@index([rut])
}

model FleteTarifa {
  id          String   @id
  nombre      String   @unique
  zona        String?
  destino     String?
  precio      Int      @default(0)
  activo      Boolean  @default(true)
  observacion String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([activo])
  @@index([zona])
}

model ImportFila {
  id         String     @id
  loteId     String
  nroFila    Int
  ok         Boolean    @default(false)
  error      String?
  raw        Json?
  createdAt  DateTime   @default(now())
  ImportLote ImportLote @relation(fields: [loteId], references: [id], onDelete: Cascade)

  @@index([loteId])
}

model ImportLote {
  id            String       @id
  tipo          String
  archivoNombre String?
  estado        String       @default("Procesado")
  totalFilas    Int          @default(0)
  filasOk       Int          @default(0)
  filasError    Int          @default(0)
  createdAt     DateTime     @default(now())
  ImportFila    ImportFila[]
}

model Inventario {
  id                String             @id
  productoId        String             @unique
  codigo            String?            @unique
  stock             Int                @default(0)
  minimo            Int                @default(0)
  ubicacion         String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime
  invNumero         Int                @unique @default(autoincrement())
  Producto          Producto           @relation(fields: [productoId], references: [id], onDelete: Cascade)
  StockAlert        StockAlert[]
  StockCriticalRule StockCriticalRule?
  StockMovimiento   StockMovimiento[]

  @@index([productoId])
  @@index([minimo])
  @@index([stock])
}

model PrecioProveedor {
  id          String    @id
  productoId  String
  proveedorId String
  precio      Int
  moneda      String    @default("CLP")
  vigente     Boolean   @default(true)
  updatedAt   DateTime
  createdAt   DateTime  @default(now())
  Producto    Producto  @relation(fields: [productoId], references: [id], onDelete: Cascade)
  Proveedor   Proveedor @relation(fields: [proveedorId], references: [id], onDelete: Cascade)

  @@unique([productoId, proveedorId])
  @@index([productoId])
  @@index([proveedorId])
}

model Producto {
  id                      String                    @id
  sku                     String?                   @unique
  nombre                  String
  unidadMedida            String                    @default("unidad")
  fotoUrl                 String?
  precioConDescto         Int                       @default(0)
  precioGeneral           Int                       @default(0)
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  tipo                    ProductoTipo              @default(Producto)
  fotoPublicId            String?
  skuNumero               Int                       @unique @default(autoincrement())
  Inventario              Inventario?
  PrecioProveedor         PrecioProveedor[]
  ProductoImagen          ProductoImagen[]
  EcommerceCarritoItem    EcommerceCarritoItem[]
  EcommerceCotizacionItem EcommerceCotizacionItem[]
  EcommercePedidoItem     EcommercePedidoItem[]

  @@index([nombre])
  @@index([tipo])
  @@index([fotoPublicId])
}

model Proveedor {
  id              String            @id
  nombre          String            @unique
  rut             String?
  email           String?
  telefono        String?
  contacto        String?
  direccion       String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  PrecioProveedor PrecioProveedor[]
}

model StockMovimiento {
  id           String              @id
  inventarioId String
  tipo         TipoMovimientoStock
  cantidad     Int
  nota         String?
  createdAt    DateTime            @default(now())
  Inventario   Inventario          @relation(fields: [inventarioId], references: [id], onDelete: Cascade)

  @@index([inventarioId])
  @@index([createdAt])
  @@index([tipo])
}

model StockAlert {
  id           String           @id
  inventarioId String
  threshold    Int
  stockAtAlert Int
  status       StockAlertStatus @default(OPEN)
  openedAt     DateTime         @default(now())
  ackAt        DateTime?
  resolvedAt   DateTime?
  lastSentAt   DateTime?
  channel      String?
  meta         Json?
  isActive     Boolean          @default(true)
  Inventario   Inventario       @relation(fields: [inventarioId], references: [id], onDelete: Cascade)

  @@unique([inventarioId, isActive])
  @@index([inventarioId, status])
  @@index([status, openedAt])
  @@index([inventarioId, isActive])
}

model StockCriticalRule {
  id                String     @id
  inventarioId      String     @unique
  enabled           Boolean    @default(true)
  thresholdOverride Int?
  cooldownMinutes   Int        @default(360)
  lastNotifiedAt    DateTime?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime
  Inventario        Inventario @relation(fields: [inventarioId], references: [id], onDelete: Cascade)

  @@index([enabled])
  @@index([inventarioId])
}

model ProductoImagen {
  id         String   @id
  productoId String
  url        String
  publicId   String
  orden      Int      @default(0)
  createdAt  DateTime @default(now())
  Producto   Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)

  @@unique([productoId, publicId])
  @@index([productoId])
  @@index([publicId])
}

model CrmCotizacion {
  id                       String               @id @default(uuid())
  clienteId                String?
  clienteNombreSnapshot    String
  clienteRutSnapshot       String?
  clienteEmailSnapshot     String?
  clienteTelefonoSnapshot  String?
  nombreObra               String?
  numeroOC                 String?
  observaciones            String?
  subtotalNeto             Int
  iva                      Int
  total                    Int
  estado                   CrmEstadoCotizacion  @default(NUEVA)
  tipoCierre               CrmTipoCierre?
  vendedorId               String?
  createdAt                DateTime             @default(now())
  updatedAt                DateTime             @updatedAt
  origenCliente            OrigenCliente?
  clienteDireccionSnapshot String?
  ecommerceCotizacion      EcommerceCotizacion?
  ecommercePedidos         EcommercePedido[]

  @@index([createdAt])
  @@index([estado])
}

model EcommerceUsuario {
  id           String            @id @default(uuid())
  nombre       String
  email        String            @unique
  telefono     String?
  passwordHash String
  estado       String            @default("ACTIVO")
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  cliente      EcommerceCliente?

  @@map("ecommerce_usuario")
}

model EcommerceCliente {
  id            String                @id @default(uuid())
  usuarioId     String?               @unique
  tipo          EcommerceClienteTipo?
  rut           String?
  nombres       String                @map("nombre")
  apellidos     String?
  emailContacto String                @unique @map("email")
  telefono      String?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  carritos      EcommerceCarrito[]
  usuario       EcommerceUsuario?     @relation(fields: [usuarioId], references: [id])
  cotizaciones  EcommerceCotizacion[]
  direcciones   EcommerceDireccion[]
  pedidos       EcommercePedido[]

  @@map("ecommerce_cliente")
}

model EcommerceDireccion {
  id                 String            @id @default(uuid())
  ecommerceClienteId String?
  pedidoId           String?           @unique
  etiqueta           String?
  nombreRecibe       String            @map("nombreContacto")
  telefonoRecibe     String            @map("telefono")
  email              String
  calle              String            @map("direccion")
  numero             String?
  depto              String?
  comuna             String
  ciudad             String?
  region             String
  codigoPostal       String?
  notas              String?
  principal          Boolean           @default(false) @map("esPrincipal")
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  ecommerceCliente   EcommerceCliente? @relation(fields: [ecommerceClienteId], references: [id])
  pedido             EcommercePedido?  @relation("PedidoDireccion", fields: [pedidoId], references: [id], onDelete: Cascade)

  @@index([ecommerceClienteId])
  @@index([ecommerceClienteId, principal])
  @@map("ecommerce_direccion")
}

model EcommerceCarrito {
  id                 String                 @id @default(uuid())
  ecommerceClienteId String?
  clienteId          String?
  estado             EcommerceEstadoCarrito @default(ACTIVO)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  ecommerceCliente   EcommerceCliente?      @relation(fields: [ecommerceClienteId], references: [id])
  items              EcommerceCarritoItem[]

  @@index([ecommerceClienteId])
  @@index([clienteId], map: "ecommerce_carrito_clienteId_legacy_idx")
  @@index([estado])
  @@map("ecommerce_carrito")
}

model EcommerceCarritoItem {
  id                         String           @id @default(uuid())
  carritoId                  String
  productoId                 String
  cantidad                   Int
  precioUnitarioNetoSnapshot Int
  subtotalNetoSnapshot       Int
  ivaPctSnapshot             Int
  ivaMontoSnapshot           Int
  totalSnapshot              Int
  createdAt                  DateTime         @default(now())
  carrito                    EcommerceCarrito @relation(fields: [carritoId], references: [id], onDelete: Cascade)
  producto                   Producto         @relation(fields: [productoId], references: [id])

  @@unique([carritoId, productoId])
  @@index([carritoId])
  @@index([productoId])
  @@map("ecommerce_carrito_item")
}

model EcommerceCotizacion {
  id                 String                    @id @default(uuid())
  correlativo        Int                       @default(autoincrement())
  codigo             String                    @unique
  origen             String                    @default("CRM")
  ecommerceClienteId String?
  clienteId          String?
  nombreContacto     String
  email              String?
  telefono           String?
  empresa            String?
  rut                String?
  observaciones      String?
  metadata           Json?
  ocCliente          String?
  subtotalNeto       Int
  iva                Int
  total              Int
  estado             EcommerceEstadoCotizacion @default(NUEVA)
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt
  crmCotizacionId    String?                   @unique
  direccion          String?
  estadoCrm          CrmEstadoCotizacion       @default(NUEVA)
  nombreObra         String?
  origenCliente      OrigenCliente?
  tipoCierre         CrmTipoCierre?
  vendedorId         String?
  crmCotizacion      CrmCotizacion?            @relation(fields: [crmCotizacionId], references: [id])
  ecommerceCliente   EcommerceCliente?         @relation(fields: [ecommerceClienteId], references: [id])
  items              EcommerceCotizacionItem[]

  @@index([ecommerceClienteId])
  @@index([clienteId], map: "ecommerce_cotizacion_clienteId_legacy_idx")
  @@index([estado])
  @@index([createdAt])
  @@index([estadoCrm])
  @@map("ecommerce_cotizacion")
}

model EcommerceCotizacionItem {
  id                         String              @id @default(uuid())
  cotizacionId               String
  productoId                 String
  skuSnapshot                String?
  descripcionSnapshot        String
  unidadSnapshot             String?
  cantidad                   Int
  observacion                String?
  precioUnitarioNetoSnapshot Int
  subtotalNetoSnapshot       Int
  ivaPctSnapshot             Int
  ivaMontoSnapshot           Int
  totalSnapshot              Int
  createdAt                  DateTime            @default(now())
  cotizacion                 EcommerceCotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  producto                   Producto            @relation(fields: [productoId], references: [id])

  @@index([cotizacionId])
  @@index([productoId])
  @@map("ecommerce_cotizacion_item")
}

model EcommerceNotificacion {
  id              String   @id @default(uuid())
  tipo            String
  referenciaTabla String
  referenciaId    String
  titulo          String
  detalle         String
  leido           Boolean  @default(false)
  createdAt       DateTime @default(now())

  @@index([leido])
  @@index([referenciaId])
  @@index([referenciaTabla])
  @@index([tipo])
  @@map("ecommerce_notificacion")
}

model EcommercePago {
  id                 String              @id @default(uuid())
  pedidoId           String
  metodo             EcommerceMetodoPago
  estado             EcommerceEstadoPago @default(PENDIENTE)
  monto              Int
  referencia         String?
  evidenciaUrl       String?
  gatewayPayloadJson Json?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  pedido             EcommercePedido     @relation(fields: [pedidoId], references: [id], onDelete: Cascade)

  @@index([estado])
  @@index([pedidoId])
  @@map("ecommerce_pago")
}

model EcommercePedido {
  id                 String                @id @default(uuid())
  correlativo        Int                   @default(autoincrement())
  codigo             String                @unique
  ecommerceClienteId String?
  clienteId          String?
  despachoNombre     String?
  despachoTelefono   String?
  despachoEmail      String?
  despachoDireccion  String?
  despachoComuna     String?
  despachoCiudad     String?
  despachoRegion     String?
  despachoNotas      String?
  subtotalNeto       Int
  iva                Int
  total              Int
  estado             EcommerceEstadoPedido @default(CREADO)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  crmCotizacionId    String?
  direccion          EcommerceDireccion?   @relation("PedidoDireccion")
  pagos              EcommercePago[]
  crmCotizacion      CrmCotizacion?        @relation(fields: [crmCotizacionId], references: [id])
  ecommerceCliente   EcommerceCliente?     @relation(fields: [ecommerceClienteId], references: [id])
  items              EcommercePedidoItem[]

  @@index([ecommerceClienteId])
  @@index([clienteId], map: "ecommerce_pedido_clienteId_legacy_idx")
  @@index([estado])
  @@map("ecommerce_pedido")
}

model EcommercePedidoItem {
  id                         String          @id @default(uuid())
  pedidoId                   String
  productoId                 String
  descripcionSnapshot        String
  cantidad                   Int
  precioUnitarioNetoSnapshot Int
  subtotalNetoSnapshot       Int
  ivaPctSnapshot             Int
  ivaMontoSnapshot           Int
  totalSnapshot              Int
  createdAt                  DateTime        @default(now())
  pedido                     EcommercePedido @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  producto                   Producto        @relation(fields: [productoId], references: [id])

  @@index([pedidoId])
  @@index([productoId])
  @@map("ecommerce_pedido_item")
}

enum OrigenCliente {
  CLIENTE_EMPRESA
  CLIENTE_ECOMMERCE
}

enum EcommerceClienteTipo {
  NATURAL
  EMPRESA
}

enum ClientStatus {
  Activo
  Inactivo
}

enum ProductoTipo {
  Producto
  Servicio
}

enum TipoMovimientoStock {
  Entrada
  Salida
  Ajuste
}

enum EcommerceEstadoCarrito {
  ACTIVO
  CONVERTIDO
  ABANDONADO
}

enum EcommerceEstadoCotizacion {
  NUEVA
  EN_REVISION
  RESPONDIDA
  CERRADA
}

enum EcommerceEstadoPedido {
  CREADO
  PAGADO
  EN_PREPARACION
  ENVIADO
  ENTREGADO
  CANCELADO
}

enum EcommerceMetodoPago {
  TRANSBANK
  APPLE_PAY
  APPLEPAY_DEV
  TRANSFERENCIA
  OTRO
}

enum EcommerceEstadoPago {
  PENDIENTE
  CONFIRMADO
  RECHAZADO
}

enum StockAlertStatus {
  OPEN
  ACK
  RESOLVED
}

enum CrmEstadoCotizacion {
  NUEVA
  EN_SEGUIMIENTO
  GANADA
  PERDIDA
}

enum CrmTipoCierre {
  PROYECTO
  COMPRA
}
