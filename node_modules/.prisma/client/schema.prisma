generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Cliente {
  id                  String                @id
  nombre              String
  rut                 String?
  email               String?
  telefono            String?
  estado              ClientStatus          @default(Activo)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  ciudad              String?
  comuna              String?
  direccion           String?
  personaContacto     String?
  region              String?
  Carrito             Carrito[]
  SolicitudCotizacion SolicitudCotizacion[]
  Pedido              Pedido[]

  @@index([nombre])
  @@index([rut])
}

model FleteTarifa {
  id          String   @id
  nombre      String
  zona        String?
  destino     String?
  precio      Int      @default(0)
  activo      Boolean  @default(true)
  observacion String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([activo])
  @@index([nombre])
  @@index([zona])
}

model ImportFila {
  id         String     @id
  loteId     String
  nroFila    Int
  ok         Boolean    @default(false)
  error      String?
  raw        Json?
  createdAt  DateTime   @default(now())
  ImportLote ImportLote @relation(fields: [loteId], references: [id], onDelete: Cascade)

  @@index([loteId])
}

model ImportLote {
  id            String       @id
  tipo          String
  archivoNombre String?
  estado        String       @default("Procesado")
  totalFilas    Int          @default(0)
  filasOk       Int          @default(0)
  filasError    Int          @default(0)
  createdAt     DateTime     @default(now())
  ImportFila    ImportFila[]
}

model Inventario {
  id              String            @id
  productoId      String
  codigo          String?
  stock           Int               @default(0)
  minimo          Int               @default(0)
  ubicacion       String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  Producto        Producto          @relation(fields: [productoId], references: [id], onDelete: Cascade)
  StockMovimiento StockMovimiento[]

  @@index([productoId])
}

model PrecioProveedor {
  id          String    @id
  productoId  String
  proveedorId String
  precio      Int
  moneda      String    @default("CLP")
  vigente     Boolean   @default(true)
  updatedAt   DateTime
  createdAt   DateTime  @default(now())
  Producto    Producto  @relation(fields: [productoId], references: [id], onDelete: Cascade)
  Proveedor   Proveedor @relation(fields: [proveedorId], references: [id], onDelete: Cascade)

  @@unique([productoId, proveedorId])
  @@index([productoId])
  @@index([proveedorId])
}

model Producto {
  id                      String                    @id
  sku                     String?                   @unique
  nombre                  String
  unidadMedida            String                    @default("unidad")
  fotoUrl                 String?
  precioConDescto         Int                       @default(0)
  precioGeneral           Int                       @default(0)
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  tipo                    ProductoTipo              @default(Producto)
  Inventario              Inventario[]
  PrecioProveedor         PrecioProveedor[]
  CarritoItem             CarritoItem[]
  SolicitudCotizacionItem SolicitudCotizacionItem[]
  PedidoItem              PedidoItem[]

  @@index([nombre])
  @@index([tipo])
}

model Proveedor {
  id              String            @id
  nombre          String            @unique
  rut             String?
  email           String?
  telefono        String?
  contacto        String?
  direccion       String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  PrecioProveedor PrecioProveedor[]
}

model StockMovimiento {
  id           String              @id
  inventarioId String
  tipo         TipoMovimientoStock
  cantidad     Int
  nota         String?
  createdAt    DateTime            @default(now())
  Inventario   Inventario          @relation(fields: [inventarioId], references: [id], onDelete: Cascade)

  @@index([inventarioId])
}

model Carrito {
  id        String        @id @default(cuid())
  token     String        @unique
  clienteId String?
  email     String?
  estado    EstadoCarrito @default(Activo)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  Cliente             Cliente?              @relation(fields: [clienteId], references: [id])
  CarritoItem         CarritoItem[]
  SolicitudCotizacion SolicitudCotizacion[]

  @@index([clienteId])
  @@index([estado])
}

model CarritoItem {
  id                 String   @id @default(cuid())
  carritoId          String
  productoId         String
  nombreProducto     String
  descripcion        String?
  unidad             String
  cantidad           Int
  precioUnitarioNeto Int
  subtotalNeto       Int
  createdAt          DateTime @default(now())

  Carrito  Carrito  @relation(fields: [carritoId], references: [id], onDelete: Cascade)
  Producto Producto @relation(fields: [productoId], references: [id])

  @@unique([carritoId, productoId])
  @@index([carritoId])
  @@index([productoId])
}

model SolicitudCotizacion {
  id              String           @id @default(cuid())
  carritoId       String?
  clienteId       String?
  nombreContacto  String
  empresa         String?
  email           String
  telefono        String
  tipoObra        String
  ubicacion       String
  observaciones   String?
  ocNumero        String?
  subtotalNeto    Int
  ivaPct          Int              @default(19)
  ivaMonto        Int
  total           Int
  moneda          String           @default("CLP")
  estado          EstadoCotizacion @default(Recibida)
  origen          OrigenRegistro   @default(ECOMMERCE)
  canal           String?
  origenRef       String?
  contenidoHash   String?
  ipHash          String?
  userAgentHash   String?
  fingerprintHash String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  Cliente                 Cliente?                  @relation(fields: [clienteId], references: [id])
  Carrito                 Carrito?                  @relation(fields: [carritoId], references: [id])
  SolicitudCotizacionItem SolicitudCotizacionItem[]
  Pago                    Pago[]
  MensajeNotificacion     MensajeNotificacion[]
  Pedido                  Pedido[]

  @@index([carritoId])
  @@index([clienteId])
  @@index([estado])
  @@index([origen])
  @@index([contenidoHash])
  @@index([ipHash])
  @@index([userAgentHash])
  @@index([fingerprintHash])
}

model SolicitudCotizacionItem {
  id                    String   @id @default(cuid())
  solicitudCotizacionId String
  productoId            String
  nombreProducto        String
  descripcion           String?
  unidad                String
  cantidad              Int
  precioUnitarioNeto    Int
  subtotalNeto          Int
  ivaPct                Int
  ivaMonto              Int
  total                 Int
  createdAt             DateTime @default(now())

  SolicitudCotizacion SolicitudCotizacion @relation(fields: [solicitudCotizacionId], references: [id], onDelete: Cascade)
  Producto            Producto            @relation(fields: [productoId], references: [id])

  @@index([solicitudCotizacionId])
  @@index([productoId])
}

model Pedido {
  id                    String         @id @default(cuid())
  solicitudCotizacionId String?
  clienteId             String?
  nombreContacto        String
  empresa               String?
  email                 String
  telefono              String
  tipoObra              String?
  ubicacion             String?
  observaciones         String?
  subtotalNeto          Int
  ivaPct                Int            @default(19)
  ivaMonto              Int
  total                 Int
  moneda                String         @default("CLP")
  estado                EstadoPedido   @default(Recibido)
  origen                OrigenRegistro @default(ECOMMERCE)
  canal                 String?
  origenRef             String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  Cliente             Cliente?             @relation(fields: [clienteId], references: [id])
  SolicitudCotizacion SolicitudCotizacion? @relation(fields: [solicitudCotizacionId], references: [id])
  PedidoItem          PedidoItem[]
  Pago                Pago[]

  @@index([clienteId])
  @@index([solicitudCotizacionId])
  @@index([estado])
  @@index([origen])
}

model PedidoItem {
  id                 String   @id @default(cuid())
  pedidoId           String
  productoId         String
  nombreProducto     String
  descripcion        String?
  unidad             String
  cantidad           Int
  precioUnitarioNeto Int
  subtotalNeto       Int
  ivaPct             Int
  ivaMonto           Int
  total              Int
  createdAt          DateTime @default(now())

  Pedido   Pedido   @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  Producto Producto @relation(fields: [productoId], references: [id])

  @@index([pedidoId])
  @@index([productoId])
}

model Pago {
  id                    String         @id @default(cuid())
  solicitudCotizacionId String?
  pedidoId              String?
  metodo                MetodoPago
  estado                EstadoPago     @default(Pendiente)
  monto                 Int
  moneda                String         @default("CLP")
  referenciaExterna     String?
  payload               Json?
  origen                OrigenRegistro @default(ECOMMERCE)
  canal                 String?
  origenRef             String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  SolicitudCotizacion SolicitudCotizacion? @relation(fields: [solicitudCotizacionId], references: [id])
  Pedido              Pedido?              @relation(fields: [pedidoId], references: [id])

  @@index([solicitudCotizacionId])
  @@index([pedidoId])
  @@index([estado])
  @@index([origen])
}

model MensajeNotificacion {
  id                    String         @id @default(cuid())
  tipo                  String
  titulo                String
  mensaje               String
  entidad               String?
  entidadId             String?
  origen                OrigenRegistro @default(ECOMMERCE)
  canal                 String?
  leido                 Boolean        @default(false)
  createdAt             DateTime       @default(now())
  solicitudCotizacionId String?

  SolicitudCotizacion SolicitudCotizacion? @relation(fields: [solicitudCotizacionId], references: [id], onDelete: Cascade)

  @@index([solicitudCotizacionId])
  @@index([leido])
  @@index([origen])
  @@index([tipo])
}

enum ClientStatus {
  Activo
  Inactivo
}

enum ProductoTipo {
  Producto
  Servicio
}

enum TipoMovimientoStock {
  Entrada
  Salida
  Ajuste
}

enum EstadoCarrito {
  Activo
  Convertido
  Abandonado
}

enum EstadoCotizacion {
  Recibida
  EnRevision
  Cotizada
  Aprobada
  Rechazada
  Cancelada
}

enum MetodoPago {
  TRANSBANK
  APPLE_PAY
  TRANSFERENCIA
  OTRO
}

enum EstadoPago {
  Pendiente
  Iniciado
  Autorizado
  Rechazado
  Anulado
}

enum EstadoPedido {
  Recibido
  EnPreparacion
  Enviado
  Entregado
  Cancelado
}

enum OrigenRegistro {
  CRM
  ECOMMERCE
}
